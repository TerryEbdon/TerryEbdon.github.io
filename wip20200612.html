<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Developer&#39;s Diary: 12-Jun-2020 Grails Security</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="myStyle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="terry_avi.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Developer&#39;s Diary
   </div>
   <div id="projectbrief">Software development, with Terry Ebdon</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('wip20200612.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">12-Jun-2020 Grails Security </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#h20200612">Spring</a><ul><li class="level2"><a href="#autotoc_md280">Logout</a></li>
<li class="level2"><a href="#autotoc_md281">User Roles</a><ul><li class="level3"><a href="#autotoc_md282">Create roles</a></li>
<li class="level3"><a href="#autotoc_md283">Create users</a></li>
<li class="level3"><a href="#autotoc_md284">Assign users to roles</a></li>
<li class="level3"><a href="#h2020-06-12_save_not_required">Don&#39;t save</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="h20200612"></a>
Spring</h1>
<p>Yesterday I added spring-security-core:4.0.0 to my Grails app. I hit a couple of problems:</p>
<ol type="1">
<li>The logout screen doesn't work.</li>
<li>User roles aren't being saved.</li>
</ol>
<h2><a class="anchor" id="autotoc_md280"></a>
Logout</h2>
<p>The logout issue is probably something silly that I've done. Not a big deal, this is just demo-ware and I don't need to demo log outs. When I get a minute I'll create a test project to see what I've screwed up.</p>
<h2><a class="anchor" id="autotoc_md281"></a>
User Roles</h2>
<p>The user roles problem is weird. Grails created three persistent classes: User, Role and UserRole. I then reversed my previous User implementation into the new class.</p>
<p><div class="plantumlgraph">
<img src="2020-06-12_grails_user_roles.png" />
</div>
 </p>
<p>I've protected the app with a static rule, in <code>grails-app/conf/application.groovy</code>:</p>
<div class="fragment"><div class="line">[pattern: &#39;/**&#39;, access: [&#39;isAuthenticated()&#39;]]</div>
</div><!-- fragment --><p>That works great, you now have to login to do anything. I'll be using role based authorisation, so need to create create <code>Role</code> instances, in sample data, and assign users to those roles.</p>
<h3><a class="anchor" id="autotoc_md282"></a>
Create roles</h3>
<div class="fragment"><div class="line">adminRole   = <span class="keyword">new</span> Role(authority: <span class="stringliteral">&#39;ROLE_ADMIN&#39;</span>).</div>
<div class="line">  save(failOnError: <span class="keyword">true</span>)</div>
<div class="line"> </div>
<div class="line">coachRole   = <span class="keyword">new</span> Role(authority: <span class="stringliteral">&#39;ROLE_COACH&#39;</span>).</div>
<div class="line">  save(failOnError: <span class="keyword">true</span>)</div>
<div class="line"> </div>
<div class="line">athleteRole = <span class="keyword">new</span> Role(authority: <span class="stringliteral">&#39;ROLE_ATHLETE&#39;</span>).</div>
<div class="line">  save(failOnError: <span class="keyword">true</span>)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md283"></a>
Create users</h3>
<p>I use a helper function to create adult users. This forces the date of birth to be 1-JAN-1970, generates a unique email address, sets the password to 'fred' and returns the saved User instance.</p>
<div class="fragment"><div class="line">User admin  = addAdult( <span class="stringliteral">&#39;Adam&#39;</span>,   <span class="stringliteral">&#39;Admin&#39;</span> )</div>
<div class="line">User coach1 = addAdult( &#39;Charlie&#39;,&#39;Curtis&#39; )</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md284"></a>
Assign users to roles</h3>
<p>This is where things go horribly wrong.</p>
<div class="fragment"><div class="line">def adminUserRole  = UserRole.create( admin,  adminRole ).</div>
<div class="line">  save(failOnError: <span class="keyword">true</span>)</div>
<div class="line"> </div>
<div class="line">def coach1UserRole = UserRole.create( coach1, coachRole ).</div>
<div class="line">  save(failOnError: <span class="keyword">true</span>)</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The <code>.save()</code> shouldn't be required. <a class="el" href="wip20200612.html#h2020-06-12_save_not_required">See below</a>.</dd></dl>
<p><code>UserRole.create()</code> creates a non-persistent object. Fair enough. But calling the object's <code>save()</code> method doesn't work, i.e. the object's <code>id</code> property is null after <code>.save( failOnError: true )</code>. This snippet reveals the problem:</p>
<div class="fragment"><div class="line">[adminUserRole, coach1UserRole].each { ur -&gt;</div>
<div class="line">  print <span class="stringliteral">&quot;Created UserRole id: ${ur.id}, &quot;</span></div>
<div class="line">  print <span class="stringliteral">&quot;username: ${ur.user.username}, &quot;</span></div>
<div class="line">  print <span class="stringliteral">&quot;authority: ${ur.role.authority}&quot;</span></div>
<div class="line">  print <span class="charliteral">&#39;\n&#39;</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The UserRole's id is null in the terminal log.</p>
<div class="fragment"><div class="line">************************</div>
<div class="line">* Creating sample data *</div>
<div class="line">************************</div>
<div class="line">Generating new password</div>
<div class="line">Generate email for Adam Admin</div>
<div class="line">Created user AdminAdam with id 1, password {bcrypt}...</div>
<div class="line">Generating new password</div>
<div class="line">Generate email for Charlie Curtis</div>
<div class="line">Created user CurtisCharlie with id 2, password {bcrypt}...</div>
<div class="line">Created UserRole id: null, username: AdminAdam, authority: ROLE_ADMIN</div>
<div class="line">Created UserRole id: null, username: CurtisCharlie, authority: ROLE_COACH</div>
</div><!-- fragment --><p>I then check the UserRole mapping with this code:</p>
<div class="fragment"><div class="line">printRoles admin</div>
<div class="line">printRoles coach1</div>
</div><!-- fragment --><p>where <code>printRoles</code> is defined as:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> printRoles( def user ) {</div>
<div class="line">  [adminRole, coachRole, athleteRole].each { role -&gt;</div>
<div class="line">    <span class="keywordtype">long</span> userId = user.id</div>
<div class="line">    <span class="keywordtype">long</span> roleId = role.id</div>
<div class="line">    println <span class="stringliteral">&quot;\nuserId: $userId, roleId: $roleId&quot;</span></div>
<div class="line">    def hasRole = UserRole.exists( userId, roleId )</div>
<div class="line"> </div>
<div class="line">    println <span class="stringliteral">&quot;${user.username} == ${role.authority} : ${hasRole}&quot;</span></div>
<div class="line">    println UserRole.get( userId, roleId )</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The terminal log confirms that no user roles have been assigned.</p>
<div class="fragment"><div class="line">userId: 1, roleId: 1</div>
<div class="line">AdminAdam == ROLE_ADMIN : false</div>
<div class="line">null</div>
<div class="line"> </div>
<div class="line">userId: 1, roleId: 2</div>
<div class="line">AdminAdam == ROLE_COACH : false</div>
<div class="line">null</div>
<div class="line"> </div>
<div class="line">userId: 1, roleId: 3</div>
<div class="line">AdminAdam == ROLE_ATHLETE : false</div>
<div class="line">null</div>
<div class="line"> </div>
<div class="line">userId: 2, roleId: 1</div>
<div class="line">CurtisCharlie == ROLE_ADMIN : false</div>
<div class="line">null</div>
<div class="line"> </div>
<div class="line">userId: 2, roleId: 2</div>
<div class="line">CurtisCharlie == ROLE_COACH : false</div>
<div class="line">null</div>
<div class="line"> </div>
<div class="line">userId: 2, roleId: 3</div>
<div class="line">CurtisCharlie == ROLE_ATHLETE : false</div>
<div class="line">null</div>
</div><!-- fragment --><p>The log is consistent with the UserRole instances not being saved. But why don't I see the <code>.save()</code> failing, due to the <code>failOnError: true</code> argument? It doesn't add up. I did some digging into Spring Security Core reference documentation. This shows the <code>User</code> class implementing an <code>authorities</code> property. Sure enough, it's defined in my <code>User</code> class. OK, let's add that to the mix:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> printRoles( def user ) {</div>
<div class="line">  <span class="comment">// ... same code as before ...</span></div>
<div class="line">  println <span class="stringliteral">&quot;Authorities: ${user.authorities}&quot;</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Running with this just confirms what I already know; the <code>UserRole</code> objects aren't being saved.</p>
<div class="fragment"><div class="line">userId: 2, roleId: 3</div>
<div class="line">CurtisCharlie == ROLE_ATHLETE : false</div>
<div class="line">null</div>
<div class="line">Authorities: []</div>
</div><!-- fragment --><h3><a class="anchor" id="h2020-06-12_save_not_required"></a>
Don't save</h3>
<p>I looked at the <a href="https://github.com/GrailsInAction/graina2/blob/fd1e5ac24fc2708c69b44392e8674796fdb22da4/ch11/hubbub/grails-app/conf/BootStrap.groovy#L150">sample code</a> for the book <em>Grails in Action, 2nd ed</em>. The only significant difference is that it doesn't call <code>.save()</code> on the created <code>UserRole</code>. So that work-around shouldn't be required. A peek at the generated <code>UserRole.create()</code> method confirms this.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> UserRole create(User user, Role role, <span class="keywordtype">boolean</span> flush = <span class="keyword">false</span>) {</div>
<div class="line">  def instance = <span class="keyword">new</span> UserRole(user: user, role: role)</div>
<div class="line">  instance.save(flush: flush)</div>
<div class="line">  instance</div>
<div class="line">}</div>
</div><!-- fragment --><p>Interesting that it explicitly returns the instance, doesn't <code>.save()</code> return the UserRole? I changed <code>UserRole.create()</code> to pass <code>failOnError: true</code> and removed the explicit saves from my bootstrap class. That made no difference. I need to recreate the problem in a throw-away project. Hopefully the throw-away will work, then I can diff the projects to find the error.</p>
<p> 
<a class='btn' href='wip20200611.html'>11-JUN-2020 👈</a>
<a class='btn' href='#h20200612'>Top of page</a>
<a class='btn' href='wip20200613.html'>👉 13-JUN-2020</a>
</p>
<p><span class="copyright">&copy; 2020 <a href="AboutMe.html" title="Terry Ebdon">Terry Ebdon.</a></span><br  />
<p>Find me coding on <a title="terry_ebdon on BitBucket"
href="https://github.com/TerryEbdon">GitHub,</a> networking on <a
title="Terry Ebdon on LinkedIn"
href="https://www.linkedin.com/in/talent/">LinkedIn</a> and hanging out on <a
title="@terry_ebdon" href="https://twitter.com/@terry_ebdon">twitter.</a> </p>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Jul 12 2020 22:03:13 for Developer&#39;s Diary by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
