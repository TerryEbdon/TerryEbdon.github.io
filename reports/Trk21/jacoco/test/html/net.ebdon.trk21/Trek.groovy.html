<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Trek.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Trk21</a> &gt; <a href="index.source.html" class="el_package">net.ebdon.trk21</a> &gt; <span class="el_source">Trek.groovy</span></div><h1>Trek.groovy</h1><pre class="source lang-java linenums">package net.ebdon.trk21;

import java.text.MessageFormat;
import org.codehaus.groovy.tools.groovydoc.ClasspathResourceManager;

import static GameSpace.*;
import static Quadrant.*;
import static ShipDevice.*;
/**
 * @file
 * @author      Terry Ebdon
 * @date        January 2019
 * @copyright
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
@brief A Groovy version of the 1973 BASIC-PLUS program TREK.BAS
@author Terry Ebdon
@date JAN-2019
*/
@groovy.util.logging.Log4j2
final class Trek extends LoggingBase {
  UiBase ui;
  PropertyResourceBundle rb;
  MessageFormat formatter;

  /// @todo Rename Trek.game, it's a misleading name for TrekCalendar
<span class="fc" id="L39">  TrekCalendar game = new TrekCalendar();</span>

    static String logPositionPieces = 'Positioning game pieces {} in quadrant {}'

<span class="fc" id="L43">    Galaxy    galaxy    = new Galaxy();</span>
<span class="fc" id="L44">    Quadrant  quadrant  = new Quadrant();</span>

    Repositioner repositioner;
    DamageControl damageControl;

<span class="fc" id="L49">    EnemyFleet enemyFleet = new EnemyFleet();</span>
    FederationShip ship;
    int numStarBasesTotal = 0; ///&lt; b9% in TREK.BAS

  int getEntQuadX() {
<span class="pc" id="L54">    ship.position.quadrant.row</span>
  }

  def setEntQuadX( newPos ) {
<span class="pc" id="L58">    ship.position.quadrant.row = newPos</span>
  }

  int getEntSectX() {
<span class="pc" id="L62">    ship.position.sector.row</span>
  }

  def setEntSectX( newPos ) {
<span class="pc" id="L66">    ship.position.sector.row = newPos</span>
  }

  int getEntQuadY() {
<span class="pc" id="L70">    ship.position.quadrant.col</span>
  }

  def setEntQuadY( newPos ) {
<span class="pc" id="L74">    ship.position.quadrant.col = newPos</span>
  }

  int getEntSectY() {
<span class="pc" id="L78">    ship.position.sector.col</span>
  }

  def setEntSectY( newPos ) {
<span class="pc" id="L82">    ship.position.sector.col = newPos</span>
  }

  def damage = [
<span class="fc" id="L86">    1: new ShipDevice('device.WARP.ENGINES'), 2: new ShipDevice('device.S.R..SENSORS'),</span>
<span class="fc" id="L87">    3: new ShipDevice('device.L.R..SENSORS'), 4: new ShipDevice('device.PHASER.CNTRL'),</span>
<span class="fc" id="L88">    5: new ShipDevice('device.PHOTON.TUBES'), 6: new ShipDevice('device.DAMAGE.CNTRL')</span>
  ]; ///&lt; D%[] and D$[] in TREK.BAS.
     ///&lt; @todo Move damage[] into FederationShip.
     ///&lt; @note elements [n][0] are keys to the Language resource bundle, via #rb.

<span class="pc bpc" id="L93" title="3 of 6 branches missed.">  boolean isValid() {</span>
<span class="pc bpc" id="L94" title="7 of 12 branches missed.">    ship != null &amp;&amp; ship.isValid() &amp;&amp;</span>
      // position != null &amp;&amp; position.isValid() &amp;&amp;
<span class="pc bpc" id="L96" title="10 of 16 branches missed.">      game != null &amp;&amp; game.isValid() &amp;&amp;</span>
<span class="pc bpc" id="L97" title="8 of 12 branches missed.">      enemyFleet != null &amp;&amp; enemyFleet.isValid()</span>
  }

  String toString() {
<span class="pc" id="L101">    &quot;Calendar   : $game\n&quot; +</span>
<span class="fc" id="L102">    &quot;Ship       : $ship\n&quot; +</span>
<span class="fc" id="L103">    &quot;EnemyFleet : $enemyFleet\n&quot; +</span>
    &quot;Quadrant   : [$entQuadX, $entQuadY]\n&quot; +
    &quot;Sector     : [$entSectX, $entSectY]&quot;
  }

  Trek( theUi = null ) {
<span class="fc" id="L109">    ui = theUi</span>
<span class="fc" id="L110">    formatter = new MessageFormat(&quot;&quot;);</span>
<span class="fc" id="L111">    formatter.setLocale( Locale.getDefault() );</span>

<span class="fc" id="L113">    ClasspathResourceManager resourceManager = new ClasspathResourceManager()</span>
<span class="fc" id="L114">    InputStream is = resourceManager.getInputStream('Language.properties')</span>

<span class="pc bpc" id="L116" title="1 of 2 branches missed.">    if ( is ) {</span>
<span class="fc" id="L117">      rb = new PropertyResourceBundle( is )</span>
<span class="fc" id="L118">      repositioner = new Repositioner( this )</span>
<span class="fc" id="L119">      damageControl = new DamageControl( damage )</span>
    } else {
<span class="nc" id="L121">        log.fatal &quot;Can't load Language.poperties&quot;</span>
<span class="pc" id="L122">        system.exit(1)</span>
    }
  }

<span class="nc bnc" id="L126" title="All 4 branches missed.">  def setupGalaxy() {</span>
<span class="nc" id="L127">    setEntStartPosition()</span>
<span class="nc" id="L128">    distributeKlingons()</span>
<span class="nc" id="L129">    dumpGalaxy()</span>
<span class="nc" id="L130">    setupQuadrant()</span>
  }

  def setEntStartPosition() {
<span class="nc" id="L134">    ship.position.quadrant = new Coords2d( *(galaxy.randomCoords) )</span>
  }

  def setupQuadrant() {
<span class="nc" id="L138">    enemyFleet.numKlingonBatCrInQuad = 0</span>
<span class="nc" id="L139">    quadrant.clear()</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">    positionShipInQuadrant()</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">    positionGamePieces()</span>
  }

  def positionShipInQuadrant() {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">    log.info &quot;Position ship within quadrant ${ship.position.quadrant}&quot;</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">    assert ship.position.quadrant.isValid()</span>
<span class="fc" id="L147">    ship.position.sector = new Coords2d( *(quadrant.randomCoords) )</span>
<span class="fc" id="L148">    quadrant[ship.position.sector] = Thing.ship</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">    log.debug &quot;Ship positioned at sector ${ship.position.sector}&quot;</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">    assert quadrant.isValid()</span>
<span class="pc" id="L151">    quadrant.dump()</span>
  }

  private updateNumEnemyShipsInQuad() {
<span class="nc bnc" id="L155" title="All 6 branches missed.">    galaxy[entQuadX,entQuadY] -= 100 * numEnemyShipsInQuad()</span>
<span class="nc" id="L156">    galaxy[entQuadX,entQuadY] += 100 * enemyFleet.numKlingonBatCrInQuad</span>
  }

  private int numEnemyShipsInQuad() {
<span class="pc" id="L160">    galaxy[entQuadX,entQuadY] / 100</span>
  }

<span class="pc bpc" id="L163" title="3 of 6 branches missed.">  private int numBasesInQuad() {</span>
<span class="pc" id="L164">    galaxy[entQuadX,entQuadY] / 10 - 10 * numEnemyShipsInQuad()</span>
  }

<span class="pc bpc" id="L167" title="3 of 6 branches missed.">  private int numStarsInQuad() {</span>
<span class="pc" id="L168">    galaxy[entQuadX,entQuadY] - numEnemyShipsInQuad() * 100 - numBasesInQuad() * 10</span>
  }

  def positionGamePieces() {

<span class="pc bpc" id="L173" title="1 of 2 branches missed.">    log.info( logPositionPieces,</span>
<span class="pc" id="L174">        galaxy.scan(ship.position.quadrant), ship.position.quadrant)</span>

<span class="pc bpc" id="L176" title="2 of 4 branches missed.">    positionEnemy()</span>
<span class="pc bpc" id="L177" title="2 of 4 branches missed.">    positionBases()</span>
<span class="pc bpc" id="L178" title="2 of 4 branches missed.">    positionStars()</span>
  }

  def positionEnemy() {
<span class="fc" id="L182">    log.info 'positionEnemy()'</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">    assert quadrant.isValid()</span>
<span class="pc bpc" id="L184" title="2 of 4 branches missed.">    enemyFleet.numKlingonBatCrInQuad = numEnemyShipsInQuad()</span>
<span class="fc" id="L185">    enemyFleet.resetQuadrant()</span>
<span class="pc bpc" id="L186" title="5 of 8 branches missed.">    log.info &quot;Positioning $enemyFleet.numKlingonBatCrInQuad Klingons in quadrant ${currentQuadrant()}.&quot;</span>
<span class="pc bpc" id="L187" title="6 of 12 branches missed.">    for ( int klingonShipNo = 1; klingonShipNo &lt;= enemyFleet.numKlingonBatCrInQuad; ++klingonShipNo ) {</span>
<span class="pc" id="L188">      def klingonPosition = getEmptySector()</span>
<span class="pc" id="L189">      quadrant[klingonPosition] = Thing.enemy</span>

<span class="pc" id="L191">      enemyFleet.positionInSector klingonShipNo, klingonPosition</span>
    }

<span class="pc bpc" id="L194" title="1 of 2 branches missed.">    log.info 'v'*16</span>
<span class="fc" id="L195">    log.info &quot;quad with Klingons&quot;</span>
<span class="pc" id="L196">    quadrant.displayOn( {log.info it} )</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">    log.info &quot;quad with Klingons&quot;</span>
<span class="pc" id="L198">    log.info '^'*16</span>
  }

  def positionStars() {
<span class="pc bpc" id="L202" title="5 of 8 branches missed.">    log.info &quot;Positioning ${numStarsInQuad()} stars.&quot;</span>
<span class="pc bpc" id="L203" title="8 of 16 branches missed.">    for ( int star = 1; star &lt;= numStarsInQuad(); ++star ) {</span>
<span class="pc" id="L204">      def starPos = getEmptySector()</span>
<span class="pc bpc" id="L205" title="3 of 4 branches missed.">      log.trace &quot;... star $star is at sector ${starPos}&quot;</span>
<span class="pc" id="L206">      quadrant[starPos[0],starPos[1]] = Thing.star</span>
<span class="pc bpc" id="L207" title="3 of 4 branches missed.">      log.trace &quot;V*: ${quadrant[starPos[0],starPos[1]]}&quot;</span>
    }
  }

  def positionBases() {
<span class="pc bpc" id="L212" title="5 of 8 branches missed.">    log.info &quot;Positioning ${numBasesInQuad()} bases.&quot;</span>
<span class="pc bpc" id="L213" title="8 of 16 branches missed.">    for ( int base = 1; base &lt;= numBasesInQuad(); ++base ) {</span>
<span class="pc" id="L214">      def basePos = getEmptySector()</span>
<span class="pc bpc" id="L215" title="3 of 4 branches missed.">      log.trace &quot;... base $base is at sector ${basePos}&quot;</span>
<span class="pc" id="L216">      quadrant[basePos] = Thing.base</span>
    }
  }

  /// @deprecated Acts as a facade for the Quadrant
  def getEmptySector() {
<span class="pc" id="L222">    quadrant.getEmptySector()</span>
  }

  int rand1to9() { // fnr%() -- Used a lot, as there are most 9 bases / Klingons / stars in each quadrant.
<span class="nc" id="L226">     new java.util.Random().nextFloat() * 8 + 1</span>
  }

  def distributeKlingons() {
<span class="nc" id="L230">    int totalStars = 0</span>
<span class="nc" id="L231">    int starsInQuad = 0</span>
    // int numBasesInQuad = 0 //b3%

<span class="nc" id="L234">    log.info &quot;Distributing Klingon battle cruisers.&quot;</span>
<span class="nc" id="L235">    minCoord.upto(maxCoord) { i-&gt;</span>
<span class="nc" id="L236">      minCoord.upto(maxCoord) { j-&gt;</span>
<span class="nc" id="L237">        enemyFleet.numKlingonBatCrInQuad = 0 // k3%</span>
        // int b9 = 0 //b9%
<span class="nc" id="L239">        def c1 = new java.util.Random().nextFloat()*64 //rnd * 64</span>

<span class="nc" id="L241">        1.upto( enemyFleet.maxKlingonBCinQuad ) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">          if ( c1 &lt; enemyFleet.softProbs[ it ] ) {</span>
<span class="nc" id="L243">            ++enemyFleet.numKlingonBatCrTotal   // line 1200</span>
<span class="nc" id="L244">            ++enemyFleet.numKlingonBatCrRemain  // line 1180</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            ++enemyFleet.numKlingonBatCrInQuad  // line 1180</span>
<span class="nc" id="L246">            log.trace &quot;Enemy craft added to quadrant ${i} - ${j}, &quot; +</span>
                      &quot;there's now ${enemyFleet.numKlingonBatCrInQuad} in this quadrant.&quot;
          }
        }

<span class="nc bnc" id="L251" title="All 2 branches missed.">        final int numBasesInQuad = new java.util.Random().nextFloat() &gt; 0.9 ? 1 : 0 // b3%</span>
<span class="nc bnc" id="L252" title="All 6 branches missed.">        numStarBasesTotal += numBasesInQuad // 1210 B9%=B9%+B3%</span>
<span class="nc" id="L253">        starsInQuad = rand1to9()</span>
<span class="nc" id="L254">        totalStars += starsInQuad</span>
<span class="nc bnc" id="L255" title="All 8 branches missed.">        galaxy[i,j] =</span>
<span class="nc" id="L256">          enemyFleet.numKlingonBatCrInQuad * 100 +</span>
<span class="nc" id="L257">          numBasesInQuad * 10 +</span>
          starsInQuad //G%(I%,J%)=K3%*100%+B3%*10%+FNR%
<span class="nc" id="L259">        log.trace 'galaxy[{},{}] = {}', i, j, galaxy.scan(i,j)</span>
      }
    }
<span class="nc bnc" id="L262" title="All 2 branches missed.">    log.info &quot;Total number of Klingon BC: ${enemyFleet.numKlingonBatCrRemain.toString().padLeft(3)}&quot;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">    log.info &quot;Total number of star bases: ${numStarBasesTotal.toString().padLeft(3)}&quot;</span>
<span class="nc bnc" id="L264" title="All 4 branches missed.">    log.info &quot;Total number stars:         ${totalStars.toString().padLeft(3)}&quot;</span>
<span class="nc" id="L265">    log.info enemyFleet.toString()</span>
  }

  def dumpGalaxy() {
<span class="nc" id="L269">    galaxy.dump()</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">    reportEntPosition()</span>
  }

<span class="nc bnc" id="L273" title="All 6 branches missed.">  def reportEntPosition() {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">    log.info &quot;Enterprise is in quadrant ${currentQuadrant()}&quot;</span>
  }

  String currentQuadrant() {
<span class="nc" id="L278">    &quot;${entQuadY} - ${entQuadX}&quot;</span>
  }

  void setupGame() {
<span class="nc bnc" id="L282" title="All 2 branches missed.">    assert damage</span>

    // try {
<span class="nc" id="L285">    logException {</span>
<span class="nc" id="L286">      ship = new FederationShip();</span>
<span class="nc" id="L287">      setupGalaxy()</span>
      // shortRangeScan()
    }
    // } catch ( Exception ex ) {
    //   log.fatal 'Unexpected exception while setting up the game.'
    //   log.error ex.message
    //   throw ex
    // }
  }

<span class="nc bnc" id="L297" title="All 4 branches missed.">  void startGame() {</span>
<span class="nc" id="L298">    shortRangeScan()</span>
  }

  /// @deprecated Not needed with new font config.
  String btnText( final String text ) {
    // &quot;&lt;html&gt;&lt;font size=+3&gt;$text&lt;/font&gt;&lt;/html&gt;&quot;
<span class="nc" id="L304">    text</span>
  }

  def msgBox( msg, boolean logIt = true ) {
<span class="nc" id="L308">    ui.outln &quot;$msg&quot;</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">    if ( logIt ) {</span>
<span class="nc" id="L310">      log.info msg</span>
    }
  }

  /// @deprecated Switch the code to use the UI version.
  Float getFloatInput( final String prompt ) {
<span class="nc" id="L316">    ui. getFloatInput( prompt )</span>
  }

  def reportDamage() {
<span class="nc" id="L320">    damageControl.report( rb, this.&amp;msgBox, formatter )</span>
  }

  def damageRepair() {
<span class="nc" id="L324">    log.info &quot;Repairing damage&quot;</span>
<span class="nc" id="L325">    damageControl.repair( this.&amp;msgBox )</span>
  }

  def attackReporter( damageAmount, message ) {
<span class="nc bnc" id="L329" title="All 2 branches missed.">    log.info &quot;Ship under attack, $damageAmount units of damage sustained.&quot;</span>
<span class="nc" id="L330">    msgBox message</span>
    //:E% -= damageAmount // Line 2410
  }

  ///@ todo: Localise klingonAttack() messages.
  def klingonAttack() {
<span class="nc bnc" id="L336" title="All 4 branches missed.">    if ( !ship.isProtectedByStarBase() ) {</span>
      // def attackReporter = { damageAmount, message -&gt;
      //   log.info &quot;Ship under attack, $damageAmount units of damage sustained.&quot;
      //   msgBox message
      //   //:E% -= damageAmount // Line 2410
      // }
<span class="nc" id="L342">      enemyFleet.attack( ship.position.sector, this.&amp;attackReporter )</span>
    } else {
<span class="nc" id="L344">      msgBox &quot;Star Base shields protect Enterprise&quot;;</span>
    }
  }

  ///@ todo: Localise spaceStorm() messages.
  def spaceStorm() {
<span class="nc" id="L350">    final int systemToDamage      = new Random().nextInt( damage.size() ) + 1</span>
<span class="nc" id="L351">    final int damageAmount        = new Random().nextInt(5) + 1</span>
<span class="nc" id="L352">    damage[systemToDamage].state -= damageAmount</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">    log.info &quot;Space storm has damaged device No. $systemToDamage&quot;</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">    log.info &quot;   damage of $damageAmount units&quot;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">    log.info &quot;   new status: ${damage[systemToDamage].state} units&quot;</span>
<span class="nc" id="L356">    msgBox( &quot;*** Space Storm, ${damage[systemToDamage].name} damaged ***&quot;)</span>
  }

  // def randomlyRepairDamage( final deviceKey ) {
  //   assert deviceKey
  //   damage[devicekey].state -=
  //     Math.floor( new Random().nextFloat() *
  //     damage[deviceKey].state -1 )
  //       // inflict damage on device -- see line 1810
  // }

  void deviceStatusLottery() {
<span class="nc bnc" id="L368" title="All 2 branches missed.">    assert damage</span>
<span class="nc" id="L369">    log.debug 'deviceStatusLottery()'</span>
<span class="nc bnc" id="L370" title="All 10 branches missed.">    if ( new Random().nextFloat() &lt;= 0.5 ) { // 1760</span>
<span class="nc" id="L371">      spaceStorm()</span>
    } else { // 1790 - Not a space storm
<span class="nc" id="L373">      log.info &quot;MORE TO DO... see lines 1790 onwards...&quot;</span>
      /// @todo MORE TO DO... see lines 1790 onwards...

      // def dc = new DamageControl( damage )
<span class="nc" id="L377">      final def firstDamagedDeviceKey = damageControl.findDamagedDeviceKey()</span>
<span class="nc bnc" id="L378" title="All 4 branches missed.">      if ( firstDamagedDeviceKey ) {</span>
<span class="nc" id="L379">          damageControl.randomlyRepair( firstDamagedDeviceKey )</span>
        // randomlyRepairDamage( firstDamagedDevice.key )
<span class="nc" id="L381">        final def damagedDeviceId = damage[firstDamagedDeviceKey].id</span>

<span class="nc" id="L383">        Object[] msgArgs = [ &quot;device.DAMAGE.$damagedDeviceId&quot; ]</span>
<span class="nc" id="L384">        formatter.applyPattern( rb.getString( 'truce' ) );</span>
<span class="nc" id="L385">        msgBox formatter.format( msgArgs );</span>
        // msgBox( &quot;*** TRUCE ${damagedDeviceName} state of repair improved ***&quot;)
      }
    }
  }

  void enemyAttacksBeforeShipCanMove() {
<span class="nc bnc" id="L392" title="All 2 branches missed.">    if ( enemyFleet.canAttack() ) {</span>
<span class="nc" id="L393">      log.info 'Klingons attack before the ship can move away.'</span>
<span class="nc bnc" id="L394" title="All 4 branches missed.">      klingonAttack()</span>
    }
  }

  /// @todo Localise setCourse()
  def setCourse() {
<span class="nc bnc" id="L400" title="All 4 branches missed.">    ShipVector vector = getShipCourse()</span>
<span class="nc bnc" id="L401" title="All 6 branches missed.">    if ( vector &amp;&amp; vector.isValid() ) {</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">      log.info &quot;Got a good vector: $vector&quot;</span>

<span class="nc bnc" id="L404" title="All 6 branches missed.">      if ( vector.warpFactor &gt; 0.2 &amp;&amp; damage[1].isDamaged() ) {</span>
<span class="nc" id="L405">        msgBox( &quot;Warp engines are damaged.\nMaximum speed is .2&quot;)</span>
      } else {
<span class="nc bnc" id="L407" title="All 4 branches missed.">        enemyAttacksBeforeShipCanMove()</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">        damageRepair() /// @todo Is damageRepair() called at the correct point?</span>

<span class="nc bnc" id="L410" title="All 10 branches missed.">        if ( new Random().nextFloat() &lt;= 0.20 ) { // 1750</span>
<span class="nc" id="L411">          deviceStatusLottery()</span>
        }
<span class="nc" id="L413">        game.tick() // Line 1830</span>
<span class="nc" id="L414">        final Coords2d oldQuadrant = ship.position.quadrant.clone()</span>
<span class="nc" id="L415">        ship.move( vector ) // set course, start engines...</span>

<span class="nc bnc" id="L417" title="All 8 branches missed.">        if ( gameContinues() ) {</span>
<span class="nc" id="L418">          log.trace &quot;Ship has moved, but where is it?&quot;</span>
          // Continue from line 1840...

<span class="nc" id="L421">          repositioner.repositionShip vector</span>
<span class="nc" id="L422">          repopulateSector oldQuadrant</span>
<span class="nc" id="L423">          shortRangeScan()</span>
        }
      }
    } else {
<span class="nc bnc" id="L427" title="All 2 branches missed.">      log.info &quot;vector is not so good: $vector&quot;</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">      if (vector.course * vector.warpFactor != 0 ) { // User didn't hit cancel</span>
<span class="nc" id="L429">        msgBox &quot;That's not a valid course / warp factor. Command refused.&quot;</span>
      }
    }
  }

  final private void repopulateSector( final oldQuadrant ) {
<span class="nc bnc" id="L435" title="All 2 branches missed.">    log.info &quot;Quadrant was $oldQuadrant&quot;</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">    log.info &quot;Quadrant now $ship.position.quadrant&quot;</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">    if ( ship.position.quadrant != oldQuadrant ) {</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">      log.info &quot;Ship jumped to new quadrant $ship.position.quadrant&quot;</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">      log.info &quot;Setup in new quadrant at $ship.position&quot;</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">      setupQuadrant()</span>
    } else {
<span class="nc" id="L442">      log.info &quot;Ship didn't jump quadrants.&quot;</span>
    }
  }

  /// @todo localise blockedAtSector( row, column )
  void blockedAtSector( row, column ) {
<span class="nc" id="L448">    msgBox &quot;Ship blocked by ${quadrant[row,column]} at sector ${logFmtCoords( row, column )}&quot;</span>
  }

  def logFmtCoords( x, y ) {
<span class="nc" id="L452">    &quot;${[x,y]} == $y - $x&quot;</span>
  }
  /// @todo Reverse the coordinates? i.e. i,j or j,i?
  /// @deprecated
  boolean sectorIsOccupied( i, j ) {
<span class="nc" id="L457">    quadrant.isOccupied(i,j)</span>
  }

  float getCourse() {
<span class="nc" id="L461">    getFloatInput( rb.getString( 'input.course' ) ) // C1</span>
  }

  /// @todo Test needed for getShipCourse()
  ShipVector getShipCourse() {
<span class="nc" id="L466">    float course        = 0</span>
<span class="nc" id="L467">    float warpFactor    = 0</span>
<span class="nc" id="L468">    ShipVector sv = new ShipVector()</span>

<span class="nc" id="L470">    log.trace '''Getting ship's course'''</span>

<span class="nc bnc" id="L472" title="All 4 branches missed.">    course = getCourse()</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">    if ( ShipVector.isValidCourse( course ) ) {</span>
<span class="nc" id="L474">      sv.course = course</span>
<span class="nc" id="L475">      warpFactor = getFloatInput( rb.getString( 'input.speed' ) ) // W1</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">      if ( ShipVector.isValidWarpFactor( warpFactor ) ) {</span>
<span class="nc" id="L477">        sv.warpFactor = warpFactor</span>
      } else {
<span class="nc bnc" id="L479" title="All 2 branches missed.">        log.info &quot;Warp factor $warpFactor is outside of expected range.&quot;</span>
      }
    } else {
<span class="nc bnc" id="L482" title="All 2 branches missed.">      log.info &quot;Course value $course is outside of expected range.&quot;</span>
    }
<span class="nc" id="L484">    sv</span>
  }

  /// Perform a @ref TrekLongRangeSensors &quot;long-range sensor scan&quot;
  def longRangeScan() {
<span class="nc bnc" id="L489" title="All 2 branches missed.">    if ( damage[3].isDamaged() ) {</span>
<span class="nc" id="L490">      msgBox rb.getString( 'sensors.longRange.offline' )</span>
    } else {
<span class="nc bnc" id="L492" title="All 4 branches missed.">      Object[] msgArgs = [ currentQuadrant() ]</span>
<span class="nc" id="L493">      formatter.applyPattern( rb.getString( 'sensors.longRange.scanQuadrant') );</span>
<span class="nc" id="L494">      msgBox formatter.format( msgArgs );</span>

      // msgBox &quot;Long range sensor scan for quadrant ${currentQuadrant()}\n&quot;
<span class="nc" id="L497">      ( entQuadX - 1 ).upto( entQuadX + 1 ) { i -&gt;    // q1% -1 to q1% + 1</span>
<span class="nc" id="L498">        String lrStatusLine = ''</span>
<span class="nc" id="L499">        ( entQuadY - 1 ).upto( entQuadY + 1 ) { j -&gt;  // q2% -1 to q2% + 1</span>
<span class="nc" id="L500">          lrStatusLine += ( '  ' + galaxy.scan( i, j ) )</span>
        }
<span class="nc" id="L502">        msgBox lrStatusLine</span>
      }
    }
  }

<span class="nc bnc" id="L507" title="All 4 branches missed.">  def showCondition() {</span>
<span class="nc" id="L508">    ui.conditionText = displayableCondition()</span>
  }

  /// @return A localised display string for the ship's condition
  /// @todo Move displayableCondition() into FederationShip
  /// @todo Localise via the #rb resource bundle.
  /// @bug  Code assumes that all condition values, other than &quot;DOCKED&quot;,
  ///       are also valid HTML colours. This is currently true for ENGLISH
  ///       locales, but will fail for other languages. Colours and language
  ///       should be orthogonal.
  /// @todo Consider splitting into two methods, to allow use where HTML is
  ///       not appropriate.
  String displayableCondition() {
    /// @bug Should use config insteaf of HTML fonts.
    /// @todo This is incompatible with a CLI based UI.
<span class="nc bnc" id="L523" title="All 2 branches missed.">    def colour = ship.condition != 'DOCKED' ? ship.condition : 'GREEN'</span>
<span class="nc" id="L524">    &quot;&lt;html&gt;&lt;font size=+2 color=$colour&gt;${ship.condition}&lt;/font&gt;&lt;/html&gt;&quot;</span>
  }

  /// Perform a @ref TrekShortRangeSensors &quot;short-range sensor scan&quot;
  def shortRangeScan() {
<span class="nc" id="L529">    logException {</span>
<span class="nc" id="L530">      ship.shortRangeScan( galaxy )</span>
<span class="nc" id="L531">      ship.attemptDocking( quadrant )</span>
      // @todo Is this methode code-complete?
      // GOSUB 2370 UNLESS A%
      // 1570 IF D%(2%) THEN &amp;&quot;SHORT RANGE SENSORS ARE INOPERABLE&quot;:GOTO1650

<span class="nc" id="L536">      msgBox( '---------------', false )</span>
<span class="nc" id="L537">      quadrant.displayOn( {msgBox it} )</span>

<span class="nc" id="L539">      msgBox( '---------------', false )</span>
<span class="nc" id="L540">      showCondition()</span>
<span class="nc" id="L541">      msgBox( sprintf(&quot;%8s: %5d  %15s: %s&quot;, rb.getString('starDate'), game.currentSolarYear, rb.getString('condition'),ship.condition ) )</span>
<span class="nc" id="L542">      msgBox( sprintf('%8s: %5s  %15s: %d - %d', rb.getString('quadrant'),currentQuadrant(), rb.getString('sector'),entSectY, entSectX ) )</span>
<span class="nc" id="L543">      msgBox( sprintf('%8s: %5d  %15s: %2d', rb.getString('energy'),ship.energyNow, rb.getString('missiles'),ship.numTorpedoes ) )</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">      msgBox( sprintf('%8s: %5d', rb.getString('enemy'), enemyFleet.numKlingonBatCrRemain ) )</span>

<span class="nc" id="L546">      log.info game.toString()</span>
    }
  }

  private void attackFleetWithPhasers( final energy ) {
<span class="nc" id="L551">    new Battle(</span>
      enemyFleet, ship, damageControl,
      this.&amp;msgBox, this.&amp;attackReporter, rb
    ).phaserAttackFleet( energy )
  }

  void updateQuadrantAfterSkirmish() {
<span class="nc bnc" id="L558" title="All 4 branches missed.">    updateNumEnemyShipsInQuad()</span>
<span class="nc" id="L559">    def enemiesAtStart = quadrant.findEnemies()</span>
<span class="nc bnc" id="L560" title="All 4 branches missed.">    log.info &quot;Found ${enemiesAtStart ? enemiesAtStart.size() : 'no'} possibly dead enemies.&quot;</span>
<span class="nc" id="L561">    enemiesAtStart.each {</span>
<span class="nc bnc" id="L562" title="All 4 branches missed.">      if ( !enemyFleet.isShipAt( it.key ) ) {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">        log.info &quot;Removing vanquished ${it.value} from sector ${it.key}&quot;</span>
<span class="nc" id="L564">        quadrant.removeEnemy( it.key )</span>
      }
    }
  }

  final void fireTorpedo() {
<span class="nc bnc" id="L570" title="All 2 branches missed.">    log.info &quot;Fire torpedo - available: ${ship.numTorpedoes}&quot;</span>

<span class="nc bnc" id="L572" title="All 6 branches missed.">    float course = getCourse()</span>
<span class="nc bnc" id="L573" title="All 6 branches missed.">    if ( course ) {</span>
<span class="nc" id="L574">      new Battle(</span>
        enemyFleet, ship, damageControl,
        this.&amp;msgBox, this.&amp;attackReporter, rb
      ).fireTorpedo( course )
    }
<span class="nc bnc" id="L579" title="All 2 branches missed.">    log.info &quot;Fire torpedo completed - available: ${ship.numTorpedoes}&quot;</span>
  }

  final void firePhasers() {
<span class="nc bnc" id="L583" title="All 2 branches missed.">    log.info &quot;Fire phasers - available energy: ${ship.energyNow}&quot;</span>

<span class="nc" id="L585">    int energy = getFloatInput( rb.getString( 'input.phaserEnergy' ) )</span>
<span class="nc bnc" id="L586" title="All 16 branches missed.">    if ( energy &gt; 0 ) {</span>
<span class="nc bnc" id="L587" title="All 4 branches missed.">      if ( energy &lt;= ship.energyNow ) {</span>
<span class="nc" id="L588">        attackFleetWithPhasers energy</span>
<span class="nc" id="L589">        updateQuadrantAfterSkirmish()</span>
      } else {
<span class="nc" id="L591">        log.info  &quot;Phaser command refused; user tried to fire too many units.&quot;</span>
<span class="nc" id="L592">        msgBox    rb.getString('phaser.refused.badEnergy')</span>
      }
    } else {
<span class="nc" id="L595">      log.info &quot;Command cancelled by user.&quot;</span>
    }
<span class="nc bnc" id="L597" title="All 2 branches missed.">    log.info &quot;Fire phasers completed - available energy: ${ship.energyNow}&quot;</span>
  }

  void victoryDance() {

<span class="nc bnc" id="L602" title="All 4 branches missed.">    Object[] msgArgs = [</span>
      game.currentSolarYear,
      enemyFleet.numKlingonBatCrTotal,
<span class="nc" id="L605">      game.elapsed(),</span>
<span class="nc" id="L606">      rating()</span>
    ]
<span class="nc" id="L608">    formatter.applyPattern( rb.getString( 'trek.victoryDance' ) );</span>
<span class="nc" id="L609">    msgBox formatter.format( msgArgs );</span>
  }

  private int rating() {
<span class="nc" id="L613">    enemyFleet.numKlingonBatCrTotal / game.elapsed() * 1000</span>
  }

  void shipDestroyed() {
<span class="nc" id="L617">    Object[] msgArgs = [</span>
      game.currentSolarYear,
      enemyFleet.numKlingonBatCrRemain,
<span class="nc" id="L620">      game.elapsed()</span>
    ]
<span class="nc" id="L622">    formatter.applyPattern( rb.getString( 'trek.funeral' ) );</span>
<span class="nc" id="L623">    msgBox formatter.format( msgArgs );</span>
  }

<span class="nc bnc" id="L626" title="All 6 branches missed.">  boolean gameContinues() {</span>
<span class="nc bnc" id="L627" title="All 16 branches missed.">    !gameWon() &amp;&amp; !gameLost()</span>
  }

  boolean gameWon() {
<span class="nc" id="L631">    enemyFleet.defeated</span>
  }

  boolean gameLost() {
<span class="nc bnc" id="L635" title="All 4 branches missed.">    ship.deadInSpace() || game.outOfTime()</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>